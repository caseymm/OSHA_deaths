
<!DOCTYPE html>
<html lang="en">
<head>
    <title>INLS 541 Final</title>

    <meta charset="UTF-8">

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
</head>
<style>
    ._4{
        width: 150px;
    }
</style>
<body>

<div class="container">

    <div id="us-chart">
        <strong>OSHA Reported Deaths by State (color: total number of deaths)</strong>
        <a class="reset" href="javascript:usChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>

        <div class="clearfix"></div>
    </div>
    
    <div class="row">
        <div id="monthly-move-chart">
            <strong>OSHA Reported Deaths by State (color: total number of deaths)</strong>
            <span class="reset" style="display: none;">range: <span class="filter"></span></span>
            <a class="reset" href="javascript:moveChart.filterAll();volumeChart.filterAll();dc.redrawAll();"
               style="display: none;">reset</a>
    
            <div class="clearfix"></div>
        </div>
    </div>
    
    <div class="row">
        <div id="monthly-volume-chart">
        </div>
        <p class="muted pull-right" style="margin-right: 15px;">select a time range to zoom in</p>
    </div>
        
    
    <!--<div id="test"></div>-->
    
    <div class="row">
        <div>
            <div class="dc-data-count">
                <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                    href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
            </div>
        </div>
    
        <table class="table table-hover dc-data-table">
            <thead>
            <tr class="header">
                <th>Date</th>
                <th>Location</th>
                <th>Description</th>
                <th>Incident Type</th>
                <th>Map</th>
            </tr>
            </thead>
        </table>
    </div>
    
    <div>
        <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
    </div>

</div>

<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript">
    //var numberFormat = d3.format(".2f");

    var usChart = dc.geoChoroplethChart("#us-chart");
    //var chart = dc.barChart("#test");
    var moveChart = dc.lineChart("#monthly-move-chart");
    var volumeChart = dc.barChart("#monthly-volume-chart"); 

    d3.csv("data/formatted/data_cleaned.csv", function (csv) {
        
        var dateFormat = d3.time.format("%m/%d/%Y").parse;
        
        csv.forEach(function (d) {
            d.dd = dateFormat(d["Date"]);
            //d.date = (d["Date"]);
            d.date = Date.parse(d["Date"]);
            //d.month = d3.time.month(d.dd); // pre-calculate month for better performance
            //console.log(d.month);
            d.number = d["Number"]; // coerce to number
            d.state = d["State"];
            d.count = +d.dd;
        });
        
        var data = crossfilter(csv);
        var all = data.groupAll();

        var states = data.dimension(function (d) {
            return d.state;
        });
        
        var stateNumberSum = states.group().reduceSum(function (d) {
            return d.number;
        });
        
        var tableDateDimension = data.dimension(function (d) {
            return d.dd;
        });
        
        var dateDimension = data.dimension(function (d) {
            return d.date;
            //return d.dd;
        });
        
        /*var moveMonths = data.dimension(function (d) {
            return d.month;
        });*/
        
        var mine = dateDimension.group().reduceSum(function (d) {
            //return Math.abs(d.count);
            return d.number;
        });
        var minDate = dateDimension.bottom(1)[0].date;
	var maxDate = dateDimension.top(1)[0].date;
        
        var yearlyDimension = data.dimension(function (d) {
            return d3.time.year(d.dd).getFullYear();
        });

        d3.json("geo/us-states.json", function (statesJson) {
            usChart.width(990)
                    .height(500)
                    .dimension(states)
                    .group(stateNumberSum)
                    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 200])
                    .colorCalculator(function (d) { return d ? usChart.colors()(d) : '#ccc'; })
                    .overlayGeoJson(statesJson.features, "state", function (d) {
                        return d.properties.name;
                    })
                    .title(function (d) {
                        return "State: " + d.key + "\nTotal Deaths: " + d.value;
                    });
        
        dc.dataTable(".dc-data-table")
            .dimension(tableDateDimension)
            .group(function (d) {
                var format = d3.format("02d")
                //var myDate = dateFormat.parse(d["Date"])
                var myDate = d.dd;
                //return (myDate.getMonth() + 1) + "/" +  format(myDate.getFullYear());
                return (myDate.getMonth() + 1) + "/" +  format(myDate.getFullYear());
            
            })
            .size(20) // (optional) max number of records to be shown, :default = 25
            .columns([
                function (d) {
                    return d.dd;
                },
                function (d) {
                    return d["Address"];
                },
                function (d) {
                    return d["Description"];
                },
                function (d) {
                    return d["Type"];
                },
                function (d) {
                    return d["Latitude"];
                    //return "<img src='http://maps.googleapis.com/maps/api/staticmap?center=" + d["Latitude"] + "," + d["Longitude"] + "&zoom=4&size=150x75&maptype=roadmap&style=feature:road|visibility:on|color:0xc8c8c6&style=feature:poi|element:geometry|visibility:off&style=feature:road|element:labels.icon|visibility:off&style=element:geometry.stroke|color:0x808080|weight:0.8&style=feature:landscape.natural|visibility:simplified|color:0xececed&markers=size:tiny%7Ccolor:0xBA0D0D%7C" + d["Latitude"] + "," + d["Longitude"] + "&sensor=false' />"
                }
            ])
            .sortBy(function (d) {
                return d.dd;
            })
            .order(d3.descending)
            .renderlet(function (table) {
                table.selectAll(".dc-table-group").classed("info", true);
            });
            
        moveChart
            .renderArea(true)
            .width(990)
            .height(200)
            .transitionDuration(1000)
            .margins({top: 30, right: 50, bottom: 25, left: 40})
            .dimension(dateDimension)
            .mouseZoomable(true)
            // Specify a range chart to link the brush extent of the range with the zoom focue of the current chart.
            .rangeChart(volumeChart)
            //.x(d3.time.scale().domain([new Date(2008, 0, 1), new Date(2014, 11, 31)]))
            .x(d3.time.scale().domain([minDate,maxDate]))
            //.round(d3.time.month.round)
            //.xUnits(d3.time.months)
            .elasticY(true)
            .renderHorizontalGridLines(true)
            //.legend(dc.legend().x(800).y(10).itemHeight(13).gap(5))
            .brushOn(false)
            // Add the base layer of the stack with group. The second parameter specifies a series name for use in the legend
            // The `.valueAccessor` will be used for the base layer
            .group(mine, "Monthly Index Average")
            .valueAccessor(function (d) {
                return d.value;
            })
            
            // title can be called by any stack layer.
            /*.title(function (d) {
                //var value = d.value.avg ? d.value.avg : d.value;
                //if (isNaN(value)) value = 0;
                return dateFormat(d.key) + "\n" + numberFormat(d.value);
            });
            */
        /*chart
            .width(768)
            .height(480)
            .x(d3.time.scale().domain([minDate,maxDate]))
            .brushOn(false)
            .dimension(dateDimension)
            .group(mine);
        
          chart.render();*/
    
        volumeChart.width(990)
            .height(40)
            .margins({top: 0, right: 50, bottom: 20, left: 40})
            .dimension(dateDimension)
            .group(mine)
            .centerBar(true)
            .gap(1)
            .x(d3.time.scale().domain([minDate,maxDate]))
            //.round(d3.time.month.round)
            //.alwaysUseRounding(true)
            //.xUnits(d3.time.months);


            dc.renderAll();
        });
    });
</script>

</body>
</html>